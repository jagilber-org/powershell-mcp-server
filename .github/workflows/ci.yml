name: CI

on:
  push:
    branches: [ master, integrate/**, feature/** ]
  pull_request:
    branches: [ master ]
  workflow_dispatch: {}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: TypeScript build
        run: npm run build:only
      - name: Jest tests
        run: npm run test:jest --if-present
      - name: Health probe (early exit)
        run: |
          npm run build:only
          node -e "process.env.START_MODE='health';import('./dist/index.js').catch(e=>{console.error(e);process.exit(1)})" > health.json
          cat health.json
          node -e "const h=require('./health.json'); if(h.status!=='ok') { console.error('Health status not ok'); process.exit(1);}"
      - name: Archive health artifact
        uses: actions/upload-artifact@v4
        with:
          name: health-json
          path: health.json

  windows-health:
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Build
        run: npm run build:only
      - name: Health script
        shell: pwsh
        run: |
          # Run the PowerShell health script directly to avoid npm adding non-JSON prefix lines
          $json = powershell -ExecutionPolicy Bypass -File scripts/health-check.ps1
          # Write only the JSON object line to file
          $json | Set-Content -Path health-win.json -Encoding utf8
      - name: Show health
        run: Get-Content health-win.json
      - name: Validate health
        run: |
          # Parse the JSON we just wrote (single-line object)
          $data = Get-Content health-win.json | ConvertFrom-Json
            if($data.status -ne 'ok'){ Write-Error "Health not ok: status=$($data.status)"; exit 1 }
            if(-not $data.package.version){ Write-Error 'Missing package.version in health JSON'; exit 1 }
            $pkgVer = (Get-Content package.json -Raw | ConvertFrom-Json).version
            if($data.package.version -ne $pkgVer){ Write-Error "Version mismatch health=$($data.package.version) package=$pkgVer"; exit 1 }
            Write-Host "Health validated OK with version $($data.package.version)"
      - name: Upload health artifact
        uses: actions/upload-artifact@v4
        with:
          name: health-win-json
          path: health-win.json

  lint-and-metrics:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Basic metrics snapshot
        run: |
          echo '{"timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","approxLines":'$(git ls-files | xargs wc -l | tail -n1 | awk '{print $1}')'}' > code-metrics.json
      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: code-metrics
          path: code-metrics.json
